#!/bin/bash

function die() {
    echo Error: "$@"
    exit -1
}

if test $# != 1; then
    die "Error: Usage $(basename $0) file, not $@"
fi

if [ x`uname -s` == xDarwin ];then
 _grep_opt="-q -e"
else
 _grep_opt="-q -P -e"
fi
if echo "$1"|grep ${_grep_opt} '\.jar$|\.dll$'; then
#if echo "$1"|grep -q -P -e '\.jar$|\.dll$'; then
    exit 0;
fi
unset _grep_opt

set -e
file=$1
cache=$HOME/.cache/code-reading-flatten$PWD/$file
def=$HOME/.cache/code-reading-defs$PWD/$file
if test ! -e $cache -o $cache -ot $file -o ! -e $def -o $def -ot $file; then
    mkdir -p $(dirname $cache) $(dirname $def)
    cat $file | tr -d '\r' | flatten.pl > $cache.bak.$$
    mv $cache.bak.$$ $cache
    (
        cd $HOME/.cache/code-reading-flatten$PWD
        grep-imenu -e '.*' -f $file -s
    ) > $def.bak.$$
    mv $def.bak.$$ $def
fi

if test $(basename $0) = java-flatten-cache; then
    echo $cache;
elif test $(basename $0) = java-tags-cache; then
    echo $def
fi
